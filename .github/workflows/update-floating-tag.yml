name: Update floating tags

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

permissions:
  contents: write  # needed to push tags

jobs:
  floating-tags:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history + tags)
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Update floating major tag (v<major>)
        shell: bash
        run: |
          set -euo pipefail

          # GITHUB_REF_NAME is like: v1.2.3
          version="${GITHUB_REF_NAME#v}"

          major="${version%%.*}" # 1.2.3 -> 1
          minor="${version%.*}" # 1.2.3 -> 1.2

          echo "Version tag: ${GITHUB_REF_NAME}"
          echo "Updating floating major tag: v${major} -> ${GITHUB_REF_NAME}"
          echo "Updating floating minor tag: v${minor} -> ${GITHUB_REF_NAME}"

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Force-move v<major> and v<minor> to point at vX.Y.Z
          git tag -f "v${major}" "${GITHUB_REF_NAME}"
          git tag -f "v${minor}" "${GITHUB_REF_NAME}"
          git push origin -f "v${major}" "v${minor}"
